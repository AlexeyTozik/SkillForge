<div>
<h1>CLCK 01: Установка ClickHouse</h1>
<div>

<h4>Возможности ClickHouse</h4>
<p>ClickHouse имеет ряд особенностей, которые выделяют его среди подобных БД, существующих на рынке.</p>
<h5>Производительность</h5>
<p>ClickHouse обладает внушительной производительностью. Для оценки можно взять во внимание несколько факторов:</p>
<ul>
<li><strong>Пропускная способность.</strong> Ее можно измерять в строках в секунду или в мегабайтах за секунду (MB/c). Если данные помещаются в page cache на современном железе, запрос может обрабатываться со скоростью около 2-10 Gb/sec. Если данные не помещаются в page cache, скорость обработки запроса ограничивается скоростью дисковой подсистемы и коэффициентом сжатия данных. К примеру, при скорости чтения данных с диска в 300МB/sec и коэффициенте сжатия 2 итоговая скорость обработки будет 600MB/sec.</li>
<li><strong>Задержки при обработке запросов</strong>. Опять же, если данные помещаются в page cache, а запрос будет использовать первичный ключ, вы можете расчитывать на задержку не более чем в 50мс. Иначе скорость выполнения будет вычисляться по формуле: <code>seek time (10мс) * кол-во столбцов в запросе * кол-во кусков с данными</code>.</li>
<li><strong>Производительность при вставке данных.</strong> Данные в ClickHouse следует вставлять не менее, чем по 1000 строк или не более одного запроса в секунду &mdash; это один из основных моментов, которые стоит запомнить. При импорте tab-separated дампа данных в таблицу движка MergeTree (семейство движков ClickHouse, о котором мы поговорим дальше) вы можете ожидать скорости в 50-200 МБ/сек. При вставке строчек в размере 1КБ каждая можно рассчитывать на скорость в 50 000 &mdash; 200 000 строчек в секунду. Если строчки маленькие &mdash; производительность будет еще выше. Также можно производить параллельно несколько <code>INSERT</code> запросов, производительность при этом растет линейно.</li>
</ul>
<p>Вы также можете найти различные бенчмарки ClickHouse в сравнении с другими базами данных здесь: <a href="https://clickhouse.tech/benchmark/dbms/">https://clickhouse.tech/benchmark/dbms/</a></p>
<h5>Колоночная СУБД</h5>
<p>Колоночные БД в целом предназначены для хранения редко изменяемых данных, таких как логи, события и т.д., а поэтому применяются, как правило, в аналитических системах или аналитических хранилищах данных. Они отлично справляются с выборкой данных, имеют хорошую скорость вставки данных, но для них дорого обходятся операции по обновлению и удалению данных.</p>
<h5>Хранение данных</h5>
<p>ClickHouse хранит данные по колонкам, то есть каждая колонка в таблице &mdash; это отдельный файл на диске. За счет этого поддерживается постоянное добавление данных в таблицу, а блокировки при этом отсутствуют. Также добавление или удаление колонок в таблице является очень дешевой операцией по сравнению со строковыми БД.</p>
<p>Данные в колонке отсортированы и проиндексированы движком MergeTree, структура их хранения напоминает индексы в строковых БД, однако между колонками нет физической связи (отдельные файлы на диске), что существенно увеличивает производительность при чтении данных с диска.</p>
<p>При чтении данных с диска колоночная БД считывает только нужные ей столбцы (файлы), в то время как строковая БД считывает весь блок данных, а потом фильтрует выборку.</p>
<h5>Сжатие данных</h5>
<p>Метод хранения данных в колоночных БД позволяет хранить данные одного типа вместе, здесь одну из ключевых ролей играет сжатие данных, что позволяет использовать гораздо меньше пространства на диске и повысить общую производительность. Чем меньше вариаций данных имеет каждая колонка, тем сильнее она может быть сжата.</p>
<h5>Особенности работы с данными</h5>
<p>В отличие от многих колоночных БД, которые могут работать только в оперативной памяти, ClickHouse спроектирован для работы на обычных жестких дисках, что существенно снижает стоимость хранения на гигабайт данных. При этом при наличии дополнительной оперативной памяти и SSD ClickHouse будет их полноценно использовать.</p>
<h5>Параллельная обработка запроса (Шардирование)</h5>
<p>Большие запросы естественным образом распараллеливаются, используя все необходимые ресурсы из доступных на сервере. Также в ClickHouse есть возможность распределенной обработки запроса на многих серверах. Можно расположить данные на разных шардах, которые представляют собой группу реплик, использующихся для отказоустойчивости. В таком случае запрос будет выполняться на всех шардах параллельно. Такой кейс мы тоже будем рассматривать.</p>
<h5>Подходит для онлайн запросов</h5>
<p>Низкие задержки позволяют не откладывать выполнение запроса и не подготавливать ответ заранее, а выполнять его именно в момент загрузки страницы пользовательского интерфейса. То есть, в режиме онлайн.</p>
<h5>Репликация данных</h5>
<p>ClickHouse имеет встроенную асинхронную multimaster репликацию, но мы рекомендуем использовать для этого Zookeeper. Этот кейс мы также рассмотрим в одном из следующих практикумов.</p>
<h5>Поддержка SQL</h5>
<p>ClickHouse поддерживает декларативный язык запросов на основе SQL и во многих случаях совпадающий с SQL стандартом. Поддерживаются такие подзапросы, как GROUP BY, ORDER BY, в секциях FROM, IN, JOIN, а также скалярные подзапросы. Зависимые подзапросы и оконные функции не поддерживаются.</p>
<h4>Установка ClickHouse</h4>
<p>ClickHouse поддерживает любую операционную систему Linux с архитектурой процессора <code>x86_64</code>, <code>AArch64</code> или <code>PowerPC64LE</code>.</p>
<p>ClickHouse можно установить разными способами: используя deb/rpm пакеты, tgz архивом, из докер-образа или собрать из иходного кода (так как проект <em>open source</em>).</p>
<p>В практикуме мы будем следовать рекомендациям и установим его, используя официальные скомпилированные <code>deb</code> или <code>rpm</code> пакеты из официального репозитория Яндекс:</p>
<ul>
<li>Debian, Ubuntu: <a href="https://repo.clickhouse.tech/deb/stable/main/">https://repo.clickhouse.tech/deb/stable/main/</a></li>
<li>CentOS, RedHad: <a href="https://repo.clickhouse.tech/rpm/stable/x86_64">https://repo.clickhouse.tech/rpm/stable/x86_64</a></li>
</ul>
<p>Если вы хотите использовать наиболее свежую версию, замените <code>stable</code> на <code>testing</code> (рекомендуется для тестовых окружений).</p>
<p>Пакеты из официального репозитория собраны под архитектуру процессора <code>x86_64</code> и используют набор инструкций <code>SSE 4.2</code>, поэтому, если не указано иное, его поддержка в используемом процессоре становится дополнительным требованием к системе.</p>
<h5>Установка</h5>
<p>Для установки нам потребуется скачать пакеты <code>clickhouse-server</code> и <code>clickhouse-client</code> с официального репозитория ClickHouse. Для этого понадобится добавить GPG ключи на машину, а также добавить ClickHouse репозиторий к разрешенному списку вашей машины, детальнее это описано <a href="https://clickhouse.tech/docs/ru/getting-started/install/#install-from-deb-packages">здесь</a>. При установке пакетов вас попросят установить пароль для стандартного пользователя, его можно оставить пустым или установить по вашему желанию.</p>
<h5>Запуск</h5>
<p>Для запуска сервера в качестве демона достаточно запустить сервис <code>clickhouse-server</code>.</p>
<p>По умолчанию сервер слушает входящие соединения на localhost:9000.</p>
<p>Файл конфигурации сервера находится в <code>/etc/clickhouse-server/config.xml</code>.</p>
<p>Логи можно посмотреть в директории <code>/var/log/clickhouse-server/</code>.</p>
<p>Также можно запустить сервер вручную из консоли, используя исполняемый файл <code>clickhouse-server</code>. В качестве файла конфигурации будет использован файл <code>./config.xml</code> из текущей директории, но возможно указать и другой путь к файлу в параметре&nbsp;<code>--config</code>.</p>
<h5>Проверка</h5>
<p>После запуска сервера соединиться с ним можно с помощью клиента командной строки:</p>
<p><code>clickhouse-client</code>.</p>
<p>По умолчанию он соединяется с localhost:9000 от имени пользователя <code>default</code> без пароля. Если вы указывали пароль для <code>default</code> пользователя при установке пакетов, то вы можете определить пароль при помощи флага <code>--password $yourpass</code> либо флага <code>--ask-password</code>, во втором случае клиент отдельно попросит ввести пароль. Также клиент может быть использован для соединения с удаленным сервером, для этого применяется аргумент <code>--host</code>.</p>
<p>Терминал должен использовать кодировку UTF-8.</p>
<h3><strong>Полезные ссылки:</strong></h3>
<ul>
<li><a href="https://clickhouse.tech/docs/ru/getting-started/install/">https://clickhouse.tech/docs/ru/getting-started/install/</a></li>
</ul>
</div>
</div>
