<div>
<h1>CLCK 14: Бэкапы в ClickHouse</h1>
<div>
<h3><strong>Описание:</strong></h3>
<p>Все мы понимаем, что бэкапы &mdash; это очень важная часть безопасности данных. И ClickHouse не исключение из правил, поэтому в данном задании мы рассмотрим вопрос о том как создавать бэкапы и восстанавливать данные если что-то пошло не так.</p>
<p>Для этих процедур в ClickHouse не потребуются никакие дополнительные инструменты, поскольку все операции проводятся напрямую с файлами.</p>
<p>Для начала стоит понимать, что на физическом уровне ClickHouse оперирует не таблицами, а партициями &mdash; частями таблиц. Поэтому процедура бэкапа состоит из следующих этапов:</p>
<ul>
<li>заморозка нужных данных (партиций);</li>
<li>копирование данных в место хранения бэкапов или на внешний сервер.</li>
</ul>
<h4>Заморозка партиций</h4>
<p>Первым нашим шагом будет заморозка нужных партиций. Но перед этим нужно выяснить, какие партиции следует заморозить. Для этого мы будем использовать системную таблицу <code>system.parts</code>, в ней содержатся все существующие партиции и информация о том, к какой БД и таблице они относятся и являются ли активными.</p>
<p>Этот запрос позволяет обратиться к системной таблице и выделить из нее активные партиции, которые относятся к выбранной БД.</p>
<pre><code>SELECT partition, table, database FROM system.parts WHERE active AND database = 'mydatabase';
</code></pre>
<p>В результате мы получим список партиций, каждую из которых необходимо заморозить.</p>
<pre><code>┌─partition─┬─table─────┬─database───┐
│ 153752    │ clients   │ mydatabase │
...
</code></pre>
<p>Заморозка делается следующей командой:</p>
<pre><code>ALTER TABLE mydatabase.clients FREEZE PARTITION '153752';
</code></pre>
<h4>Копирование данных</h4>
<p>После первой замороженной партиции ClickHouse создает в директории <code>/var/lib/clickhouse/shadow/N/</code> бэкапы с такой же структурой, как в основной папке с данными. <code>N</code> &mdash; это инкрементальный номер бэкапа, поэтому, если это ваш первый бэкап, он будет равен <code>1</code>. Такие бэкапы создаются очень быстро даже для больших таблиц, так как для этого используются жесткие ссылки.</p>
<p>Вот и все, после того, как мы заморозили все необходимые партиции, данные доступны для копирования в выбранную директории либо на внешний сервер.</p>
<p>Также есть смысл копировать не только сами данные, но и захватить метаданные, которые хранятся в <code>/var/lib/clickhouse/metadata/mydatabase</code>. В этой директории будут храниться SQL-файлы с определением структуры таблиц. В нашем случае это будет выглядеть вот так: <code>/var/lib/clickhouse/metadata/mydatabase/clients.sql</code>.</p>
<h4>Восстановление данных</h4>
<p>Эта процедура не слишком сложная и во многом является почти зеркальной созданию бэкапов.</p>
<p>Для начала нужно создать новую БД:</p>
<pre><code>CREATE DATABASE newdatabase;
</code></pre>
<p>После нам нужно создать в ней таблицы, которые у нас были. Сделать это можно используя SQL запросы из нашего файла с метаданными, которые мы скопировали ранее, а именно <code>clients.sql</code>:</p>
<pre><code>cat /path/to/backups/clients.sql | clickhouse-client --database newdatabase
</code></pre>
<p>После того, как таблицы были созданы, необходимо скопировать данные в директорию ClickHouse в папку <code>detached</code>.</p>
<pre><code>cp -r /path/to/backups/clients /var/lib/clickhouse/data/newdatabase/clients/detached/
</code></pre>
<p>Убедимся, что у ClickHouse есть все права на данные:</p>
<pre><code>chown clickhouse:clickhouse -R /var/lib/clickhouse/data/newdatabase/clients/
</code></pre>
<p>И последний шаг &mdash; это сделать <code>ATTACH</code> для всех партиций таблиц.</p>
<pre><code>ALTER TABLE newdatabase.clients ATTACH PARTITION '153752';
</code></pre>
<p>Теперь данные должны быть на своем месте, а новая БД и таблицы в ней &mdash; готовы к использованию.</p>
<h3><strong>Полезные ссылки:</strong></h3>
<ul>
<li><a href="https://clickhouse.tech/docs/ru/operations/backup/">https://clickhouse.tech/docs/ru/operations/backup/</a></li>
</ul>
</div>
<div>&nbsp;</div>
</div>
